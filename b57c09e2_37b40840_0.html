<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns:v="urn:schemas-microsoft-com:vml" xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns:m="http://schemas.microsoft.com/office/2004/12/omml" xmlns="http://www.w3.org/TR/REC-html40">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<meta name="ProgId" content="Word.Document" />
		<meta name="Generator" content="Microsoft Word 15" />
		<meta name="Originator" content="Microsoft Word 15" />
		<link rel="File-List" href="filelist.xml" />
		<link rel="Edit-Time-Data" href="editdata.mso" />
		<link rel="OLE-Object-Data" href="oledata.mso" />
		<link rel="themeData" href="nyf6_msword_rtf2html.files/themedata.thmx" />
		<link rel="colorSchemeMapping" href="colorschememapping.xml" />
		<style>
			<!--
			/* Font Definitions */
			@font-face
			{font-family:宋体;
			panose-1:2 1 6 0 3 1 1 1 1 1;
			mso-font-alt:SimSun;
			mso-font-charset:134;
			mso-generic-font-family:auto;
			mso-font-pitch:variable;
			mso-font-signature:3 680460288 22 0 262145 0;}
			@font-face
			{font-family:宋体;
			panose-1:2 1 6 0 3 1 1 1 1 1;
			mso-font-alt:SimSun;
			mso-font-charset:134;
			mso-generic-font-family:auto;
			mso-font-pitch:variable;
			mso-font-signature:3 680460288 22 0 262145 0;}
			@font-face
			{font-family:Calibri;
			panose-1:2 15 5 2 2 2 4 3 2 4;
			mso-font-charset:0;
			mso-generic-font-family:swiss;
			mso-font-pitch:variable;
			mso-font-signature:-536870145 1073786111 1 0 415 0;}
			@font-face
			{font-family:微软雅黑;
			panose-1:2 11 5 3 2 2 4 2 2 4;
			mso-font-charset:134;
			mso-generic-font-family:swiss;
			mso-font-pitch:variable;
			mso-font-signature:-2147483001 672087122 22 0 262175 0;}
			@font-face
			{font-family:"\@微软雅黑";
			panose-1:2 11 5 3 2 2 4 2 2 4;
			mso-font-charset:134;
			mso-generic-font-family:swiss;
			mso-font-pitch:variable;
			mso-font-signature:-2147483001 672087122 22 0 262175 0;}
			@font-face
			{font-family:"\@宋体";
			panose-1:2 1 6 0 3 1 1 1 1 1;
			mso-font-charset:134;
			mso-generic-font-family:auto;
			mso-font-pitch:variable;
			mso-font-signature:3 680460288 22 0 262145 0;}
			@font-face
			{font-family:??;
			panose-1:0 0 0 0 0 0 0 0 0 0;
			mso-font-alt:"Arial Unicode MS";
			mso-font-charset:0;
			mso-generic-font-family:auto;
			mso-font-format:other;
			mso-font-pitch:auto;
			mso-font-signature:0 135135232 16 0 262145 0;}
			/* Style Definitions */
			p.MsoNormal, li.MsoNormal, div.MsoNormal
			{mso-style-unhide:no;
			mso-style-qformat:yes;
			mso-style-parent:"";
			margin:0cm;
			margin-bottom:.0001pt;
			text-align:justify;
			text-justify:inter-ideograph;
			mso-pagination:none;
			font-size:10.5pt;
			mso-bidi-font-size:11.0pt;
			font-family:"Calibri","sans-serif";
			mso-ascii-font-family:Calibri;
			mso-ascii-theme-font:minor-latin;
			mso-fareast-font-family:宋体;
			mso-fareast-theme-font:minor-fareast;
			mso-hansi-font-family:Calibri;
			mso-hansi-theme-font:minor-latin;
			mso-bidi-font-family:"Times New Roman";
			mso-bidi-theme-font:minor-bidi;
			mso-font-kerning:1.0pt;}
			.MsoChpDefault
			{mso-style-type:export-only;
			mso-default-props:yes;
			font-size:10.5pt;
			mso-ansi-font-size:10.5pt;
			mso-bidi-font-size:11.0pt;
			mso-ascii-font-family:Calibri;
			mso-ascii-theme-font:minor-latin;
			mso-fareast-font-family:宋体;
			mso-fareast-theme-font:minor-fareast;
			mso-hansi-font-family:Calibri;
			mso-hansi-theme-font:minor-latin;
			mso-bidi-font-family:"Times New Roman";
			mso-bidi-theme-font:minor-bidi;
			mso-font-kerning:1.0pt;}
			/* Page Definitions */
			@page
			{mso-page-border-surround-header:no;
			mso-page-border-surround-footer:no;
			mso-footnote-separator:url("nyf6_msword_rtf2html.files/header.html") fs;
			mso-footnote-continuation-separator:url("nyf6_msword_rtf2html.files/header.html") fcs;
			mso-endnote-separator:url("nyf6_msword_rtf2html.files/header.html") es;
			mso-endnote-continuation-separator:url("nyf6_msword_rtf2html.files/header.html") ecs;}
			@page WordSection1
			{size:612.0pt 792.0pt;
			margin:72.0pt 90.0pt 72.0pt 90.0pt;
			mso-header-margin:36.0pt;
			mso-footer-margin:36.0pt;
			mso-paper-source:0;}
			div.WordSection1
			{page:WordSection1;}
			-->
		</style>
	</head>
	<body lang="ZH-CN" style="tab-interval:36.0pt;text-justify-trim:punctuation">
		<div class="WordSection1">
			<p class="MsoNormal" align="left" style="text-align:left;tab-stops:54.0pt 108.0pt 162.0pt 216.0pt 270.0pt 324.0pt 378.0pt 432.0pt 486.0pt 540.0pt 594.0pt 648.0pt 702.0pt 756.0pt 810.0pt 864.0pt 918.0pt 972.0pt 1026.0pt 1080.0pt 40.0cm 1188.0pt 1242.0pt 1296.0pt 1350.0pt 1404.0pt 1458.0pt 1512.0pt 1566.0pt;
mso-layout-grid-align:none;text-autospace:none"><span style="font-family: 微软雅黑, sans-serif; font-size: 19px; ">1. RateLimiter属性解释</span>
			</p>
			<p class="MsoNormal" align="left" style="text-align:left;tab-stops:54.0pt 108.0pt 162.0pt 216.0pt 270.0pt 324.0pt 378.0pt 432.0pt 486.0pt 540.0pt 594.0pt 648.0pt 702.0pt 756.0pt 810.0pt 864.0pt 918.0pt 972.0pt 1026.0pt 1080.0pt 40.0cm 1188.0pt 1242.0pt 1296.0pt 1350.0pt 1404.0pt 1458.0pt 1512.0pt 1566.0pt;
mso-layout-grid-align:none;text-autospace:none"><span style="font-size:14.0pt;
font-family:'微软雅黑','sans-serif';mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin;mso-bidi-font-family:微软雅黑;color:black;mso-font-kerning:0pt;
mso-ansi-language:ZH-CN"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>1.1
double maxBurstSeconds：在没有请求访问时，RateLimiter最多存储几秒的令牌；<o:p></o:p></span>
			</p>
			<p class="MsoNormal" align="left" style="text-align:left;tab-stops:54.0pt 108.0pt 162.0pt 216.0pt 270.0pt 324.0pt 378.0pt 432.0pt 486.0pt 540.0pt 594.0pt 648.0pt 702.0pt 756.0pt 810.0pt 864.0pt 918.0pt 972.0pt 1026.0pt 1080.0pt 40.0cm 1188.0pt 1242.0pt 1296.0pt 1350.0pt 1404.0pt 1458.0pt 1512.0pt 1566.0pt;
mso-layout-grid-align:none;text-autospace:none"><span style="font-size:14.0pt;
font-family:'微软雅黑','sans-serif';mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin;mso-bidi-font-family:微软雅黑;color:black;mso-font-kerning:0pt;
mso-ansi-language:ZH-CN"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>1.2
double storedPermits：当前存储的令牌数；<o:p></o:p></span>
			</p>
			<p class="MsoNormal" align="left" style="text-align:left;tab-stops:54.0pt 108.0pt 162.0pt 216.0pt 270.0pt 324.0pt 378.0pt 432.0pt 486.0pt 540.0pt 594.0pt 648.0pt 702.0pt 756.0pt 810.0pt 864.0pt 918.0pt 972.0pt 1026.0pt 1080.0pt 40.0cm 1188.0pt 1242.0pt 1296.0pt 1350.0pt 1404.0pt 1458.0pt 1512.0pt 1566.0pt;
mso-layout-grid-align:none;text-autospace:none"><span style="font-size:14.0pt;
font-family:'微软雅黑','sans-serif';mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin;mso-bidi-font-family:微软雅黑;color:black;mso-font-kerning:0pt;
mso-ansi-language:ZH-CN"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>1.3
double maxPermits：最大存储令牌数，maxPermits = maxBurstSeconds * permitsPerSecond（每秒<o:p></o:p></span>
			</p>
			<p class="MsoNormal" align="left" style="text-align:left;tab-stops:54.0pt 108.0pt 162.0pt 216.0pt 270.0pt 324.0pt 378.0pt 432.0pt 486.0pt 540.0pt 594.0pt 648.0pt 702.0pt 756.0pt 810.0pt 864.0pt 918.0pt 972.0pt 1026.0pt 1080.0pt 40.0cm 1188.0pt 1242.0pt 1296.0pt 1350.0pt 1404.0pt 1458.0pt 1512.0pt 1566.0pt;
mso-layout-grid-align:none;text-autospace:none"><span style="font-size:14.0pt;
font-family:'微软雅黑','sans-serif';mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin;mso-bidi-font-family:微软雅黑;color:black;mso-font-kerning:0pt;
mso-ansi-language:ZH-CN"><span style="mso-tab-count:2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>生成的令牌数）；<o:p></o:p></span>
			</p>
			<p class="MsoNormal" align="left" style="text-align:left;tab-stops:54.0pt 108.0pt 162.0pt 216.0pt 270.0pt 324.0pt 378.0pt 432.0pt 486.0pt 540.0pt 594.0pt 648.0pt 702.0pt 756.0pt 810.0pt 864.0pt 918.0pt 972.0pt 1026.0pt 1080.0pt 40.0cm 1188.0pt 1242.0pt 1296.0pt 1350.0pt 1404.0pt 1458.0pt 1512.0pt 1566.0pt;
mso-layout-grid-align:none;text-autospace:none"><span style="font-size:14.0pt;
font-family:'微软雅黑','sans-serif';mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin;mso-bidi-font-family:微软雅黑;color:black;mso-font-kerning:0pt;
mso-ansi-language:ZH-CN"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>1.4
double stableIntervalMicros：多少微秒内添加一个令牌，计算方式为：<o:p></o:p></span>
			</p>
			<p class="MsoNormal" align="left" style="text-align:left;tab-stops:54.0pt 108.0pt 162.0pt 216.0pt 270.0pt 324.0pt 378.0pt 432.0pt 486.0pt 540.0pt 594.0pt 648.0pt 702.0pt 756.0pt 810.0pt 864.0pt 918.0pt 972.0pt 1026.0pt 1080.0pt 40.0cm 1188.0pt 1242.0pt 1296.0pt 1350.0pt 1404.0pt 1458.0pt 1512.0pt 1566.0pt;
mso-layout-grid-align:none;text-autospace:none"><span style="font-size:14.0pt;
font-family:'微软雅黑','sans-serif';mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin;mso-bidi-font-family:微软雅黑;color:black;mso-font-kerning:0pt;
mso-ansi-language:ZH-CN"><span style="mso-tab-count:2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>1000000（1秒=1000000微秒）
/ permitsPerSecond（每秒生成的令牌数）；<o:p></o:p></span>
			</p>
			<p class="MsoNormal" align="left" style="text-align:left;tab-stops:54.0pt 108.0pt 162.0pt 216.0pt 270.0pt 324.0pt 378.0pt 432.0pt 486.0pt 540.0pt 594.0pt 648.0pt 702.0pt 756.0pt 810.0pt 864.0pt 918.0pt 972.0pt 1026.0pt 1080.0pt 40.0cm 1188.0pt 1242.0pt 1296.0pt 1350.0pt 1404.0pt 1458.0pt 1512.0pt 1566.0pt;
mso-layout-grid-align:none;text-autospace:none"><span style="font-size:14.0pt;
font-family:'微软雅黑','sans-serif';mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin;mso-bidi-font-family:微软雅黑;color:black;mso-font-kerning:0pt;
mso-ansi-language:ZH-CN"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>1.5
long nextFreeTicketMicros：下一次请求可以获取令牌的开始时间，如果<o:p></o:p></span>
			</p>
			<p class="MsoNormal" align="left" style="text-align:left;tab-stops:54.0pt 108.0pt 162.0pt 216.0pt 270.0pt 324.0pt 378.0pt 432.0pt 486.0pt 540.0pt 594.0pt 648.0pt 702.0pt 756.0pt 810.0pt 864.0pt 918.0pt 972.0pt 1026.0pt 1080.0pt 40.0cm 1188.0pt 1242.0pt 1296.0pt 1350.0pt 1404.0pt 1458.0pt 1512.0pt 1566.0pt;
mso-layout-grid-align:none;text-autospace:none"><span style="font-size:14.0pt;
font-family:'微软雅黑','sans-serif';mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin;mso-bidi-font-family:微软雅黑;color:black;mso-font-kerning:0pt;
mso-ansi-language:ZH-CN"><span style="mso-tab-count:2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>当前时间
&lt; nextFreeTicketMicros，则进行阻塞，这就是RateLimiter滞后处理的关键点；<o:p></o:p></span>
			</p>
			<p class="MsoNormal" align="left" style="text-align:left;tab-stops:54.0pt 108.0pt 162.0pt 216.0pt 270.0pt 324.0pt 378.0pt 432.0pt 486.0pt 540.0pt 594.0pt 648.0pt 702.0pt 756.0pt 810.0pt 864.0pt 918.0pt 972.0pt 1026.0pt 1080.0pt 40.0cm 1188.0pt 1242.0pt 1296.0pt 1350.0pt 1404.0pt 1458.0pt 1512.0pt 1566.0pt;
mso-layout-grid-align:none;text-autospace:none"><span style="font-size:14.0pt;
font-family:'微软雅黑','sans-serif';mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin;mso-bidi-font-family:微软雅黑;color:black;mso-font-kerning:0pt;
mso-ansi-language:ZH-CN"><o:p>&nbsp;</o:p></span>
			</p>
			<div style="mso-element:para-border-div;border:dashed windowtext 1.0pt;
mso-border-alt:dashed windowtext .25pt;padding:0cm 0cm 0cm 0cm;background:white">
				<p class="MsoNormal" align="left" style="text-align:left;background:white;
mso-layout-grid-align:none;text-autospace:none;border:none;mso-border-alt:dashed windowtext .25pt;
padding:0cm;mso-padding-alt:0cm 0cm 0cm 0cm"><span style="font-size:14.0pt;
font-family:'微软雅黑','sans-serif';mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin;mso-bidi-font-family:微软雅黑;color:black;mso-font-kerning:0pt;
mso-ansi-language:ZH-CN">2. RateLimiter生成令牌方式<o:p></o:p></span>
				</p>
				<p class="MsoNormal" align="left" style="text-align:left;background:white;
mso-layout-grid-align:none;text-autospace:none;border:none;mso-border-alt:dashed windowtext .25pt;
padding:0cm;mso-padding-alt:0cm 0cm 0cm 0cm"><span style="font-size:14.0pt;
font-family:'微软雅黑','sans-serif';mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin;mso-bidi-font-family:微软雅黑;color:black;mso-font-kerning:0pt;
mso-ansi-language:ZH-CN"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>2.1
开启一个定时任务，由定时任务持续生成令牌。这样的问题在于会极大的消耗系统资源，如：某接口需要<o:p></o:p></span>
				</p>
				<p class="MsoNormal" align="left" style="text-align:left;background:white;
mso-layout-grid-align:none;text-autospace:none;border:none;mso-border-alt:dashed windowtext .25pt;
padding:0cm;mso-padding-alt:0cm 0cm 0cm 0cm"><span style="font-size:14.0pt;
font-family:'微软雅黑','sans-serif';mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin;mso-bidi-font-family:微软雅黑;color:black;mso-font-kerning:0pt;
mso-ansi-language:ZH-CN"><span style="mso-tab-count:2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>分别对每个用户做访问频率限制，假设系统中存在6W用户，则至多需要开启6W个定时任务来维持每个桶<o:p></o:p></span>
				</p>
				<p class="MsoNormal" align="left" style="text-align:left;background:white;
mso-layout-grid-align:none;text-autospace:none;border:none;mso-border-alt:dashed windowtext .25pt;
padding:0cm;mso-padding-alt:0cm 0cm 0cm 0cm"><span style="font-size:14.0pt;
font-family:'微软雅黑','sans-serif';mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin;mso-bidi-font-family:微软雅黑;color:black;mso-font-kerning:0pt;
mso-ansi-language:ZH-CN"><span style="mso-tab-count:2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>中的令牌数，这样的开销是巨大的；<o:p></o:p></span>
				</p>
				<p class="MsoNormal" align="left" style="text-align:left;background:white;
mso-layout-grid-align:none;text-autospace:none;border:none;mso-border-alt:dashed windowtext .25pt;
padding:0cm;mso-padding-alt:0cm 0cm 0cm 0cm"><span style="font-size:14.0pt;
font-family:'微软雅黑','sans-serif';mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin;mso-bidi-font-family:微软雅黑;color:black;mso-font-kerning:0pt;
mso-ansi-language:ZH-CN"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>2.2
RateLimiter的做法是，每次获取令牌之前调用生成令牌，其实现思路为，若<o:p></o:p></span>
				</p>
				<p class="MsoNormal" align="left" style="text-align:left;background:white;
mso-layout-grid-align:none;text-autospace:none;border:none;mso-border-alt:dashed windowtext .25pt;
padding:0cm;mso-padding-alt:0cm 0cm 0cm 0cm"><span style="font-size:14.0pt;
font-family:'微软雅黑','sans-serif';mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin;mso-bidi-font-family:微软雅黑;color:black;mso-font-kerning:0pt;
mso-ansi-language:ZH-CN"><span style="mso-tab-count:2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>当前时间大于nextFreeTicketMicros，则计算该段时间内可以生成多少令牌，将生成的令牌加入令牌桶中<o:p></o:p></span>
				</p>
				<p class="MsoNormal" align="left" style="text-align:left;background:white;
mso-layout-grid-align:none;text-autospace:none;border:none;mso-border-alt:dashed windowtext .25pt;
padding:0cm;mso-padding-alt:0cm 0cm 0cm 0cm"><span style="font-size:14.0pt;
font-family:'微软雅黑','sans-serif';mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin;mso-bidi-font-family:微软雅黑;color:black;mso-font-kerning:0pt;
mso-ansi-language:ZH-CN"><span style="mso-tab-count:2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>并更新数据。这样一来，只需要在获取令牌时计算一次即可。<o:p></o:p></span>
				</p>
			</div>
			<p class="MsoNormal" align="left" style="text-align:left;tab-stops:54.0pt 108.0pt 162.0pt 216.0pt 270.0pt 324.0pt 378.0pt 432.0pt 486.0pt 540.0pt 594.0pt 648.0pt 702.0pt 756.0pt 810.0pt 864.0pt 918.0pt 972.0pt 1026.0pt 1080.0pt 40.0cm 1188.0pt 1242.0pt 1296.0pt 1350.0pt 1404.0pt 1458.0pt 1512.0pt 1566.0pt;
mso-layout-grid-align:none;text-autospace:none"><span style="font-size:14.0pt;
font-family:'微软雅黑','sans-serif';mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin;mso-bidi-font-family:微软雅黑;color:black;mso-font-kerning:0pt;
mso-ansi-language:ZH-CN"><o:p>&nbsp;</o:p></span>
			</p>
			<p class="MsoNormal" align="left" style="text-align:left;tab-stops:54.0pt 108.0pt 162.0pt 216.0pt 270.0pt 324.0pt 378.0pt 432.0pt 486.0pt 540.0pt 594.0pt 648.0pt 702.0pt 756.0pt 810.0pt 864.0pt 918.0pt 972.0pt 1026.0pt 1080.0pt 40.0cm 1188.0pt 1242.0pt 1296.0pt 1350.0pt 1404.0pt 1458.0pt 1512.0pt 1566.0pt;
mso-layout-grid-align:none;text-autospace:none"><span style="font-size:14.0pt;
font-family:'微软雅黑','sans-serif';mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin;mso-bidi-font-family:微软雅黑;color:black;mso-font-kerning:0pt;
mso-ansi-language:ZH-CN">3. RateLimiter创建<o:p></o:p></span>
			</p>
			<div style="mso-element:para-border-div;border:dashed windowtext 1.0pt;
mso-border-alt:dashed windowtext .25pt;padding:0cm 0cm 0cm 0cm;background:white;
margin-left:20.0pt;margin-right:0cm">
				<p class="MsoNormal" align="left" style="text-align:left;background:white;
mso-layout-grid-align:none;text-autospace:none;border:none;mso-border-alt:dashed windowtext .25pt;
padding:0cm;mso-padding-alt:0cm 0cm 0cm 0cm"><strong><span style="font-size:13.5pt;
font-family:??;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;
mso-bidi-font-family:??;color:navy;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">public
static </span></strong><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:black;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">RateLimiter create(</span><strong><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:navy;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">double </span></strong><span style="font-size:13.5pt;
font-family:??;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;
mso-bidi-font-family:??;color:black;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN">permitsPerSecond) {<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span><strong><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:navy;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">return </span></strong><em><span style="font-size:13.5pt;
font-family:??;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;
mso-bidi-font-family:??;color:black;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN">create</span></em><span style="font-size:13.5pt;font-family:??;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;mso-bidi-font-family:
??;color:black;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">(permitsPerSecond,
SleepingStopwatch.createFromSystemTimer());<br />}<br /><br /></span><strong><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:navy;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">static </span></strong><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:black;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">RateLimiter create(</span><strong><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:navy;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">double </span></strong><span style="font-size:13.5pt;
font-family:??;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;
mso-bidi-font-family:??;color:black;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN">permitsPerSecond, SleepingStopwatch stopwatch) {<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>RateLimiter
rateLimiter = </span><strong><span style="font-size:13.5pt;font-family:??;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;mso-bidi-font-family:
??;color:navy;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">new </span></strong><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:black;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">SmoothBursty(stopwatch, </span><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:blue;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">1.0 </span><em><span style="font-size:13.5pt;
font-family:??;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;
mso-bidi-font-family:??;color:gray;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">/*
maxBurstSeconds */</span></em><span style="font-size:13.5pt;font-family:??;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;mso-bidi-font-family:
??;color:black;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">);<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;</span>rateLimiter.setRate(permitsPerSecond);<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span><strong><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:navy;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">return </span></strong><span style="font-size:13.5pt;
font-family:??;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;
mso-bidi-font-family:??;color:black;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN">rateLimiter;<br />}</span><span style="font-size:14.0pt;font-family:'微软雅黑','sans-serif';
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;mso-bidi-font-family:
微软雅黑;color:black;mso-font-kerning:0pt;mso-ansi-language:ZH-CN"><o:p></o:p></span>
				</p>
				<p class="MsoNormal" align="left" style="text-align:left;background:white;
mso-layout-grid-align:none;text-autospace:none;border:none;mso-border-alt:dashed windowtext .25pt;
padding:0cm;mso-padding-alt:0cm 0cm 0cm 0cm"><span style="font-size:14.0pt;
font-family:'微软雅黑','sans-serif';mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin;mso-bidi-font-family:微软雅黑;color:black;mso-font-kerning:0pt;
mso-ansi-language:ZH-CN">3.1 permitsPerSecond：每秒生成permitsPerSecond枚令牌；<o:p></o:p></span>
				</p>
				<p class="MsoNormal" align="left" style="text-align:left;background:white;
mso-layout-grid-align:none;text-autospace:none;border:none;mso-border-alt:dashed windowtext .25pt;
padding:0cm;mso-padding-alt:0cm 0cm 0cm 0cm"><span style="font-size:14.0pt;
font-family:'微软雅黑','sans-serif';mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin;mso-bidi-font-family:微软雅黑;color:black;mso-font-kerning:0pt;
mso-ansi-language:ZH-CN">3.2 SleepingStopwatch：guava中的一个时钟类实例，用于计算时间；<o:p></o:p></span>
				</p>
				<p class="MsoNormal" align="left" style="text-align:left;background:white;
mso-layout-grid-align:none;text-autospace:none;border:none;mso-border-alt:dashed windowtext .25pt;
padding:0cm;mso-padding-alt:0cm 0cm 0cm 0cm"><span style="font-size:14.0pt;
font-family:'微软雅黑','sans-serif';mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin;mso-bidi-font-family:微软雅黑;color:black;mso-font-kerning:0pt;
mso-ansi-language:ZH-CN">3.3 maxBurstSeconds：在ReteLimiter未使用时，最多保存几秒的令牌，默认是1；<o:p></o:p></span>
				</p>
			</div>
			<div style="mso-element:para-border-div;border:dashed windowtext 1.0pt;
mso-border-alt:dashed windowtext .25pt;padding:0cm 0cm 0cm 0cm;background:white">
				<p class="MsoNormal" align="left" style="text-align:left;background:white;
mso-layout-grid-align:none;text-autospace:none;border:none;mso-border-alt:dashed windowtext .25pt;
padding:0cm;mso-padding-alt:0cm 0cm 0cm 0cm"><span style="font-size:14.0pt;
font-family:'微软雅黑','sans-serif';mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin;mso-bidi-font-family:微软雅黑;color:black;mso-font-kerning:0pt;
mso-ansi-language:ZH-CN"><o:p>&nbsp;</o:p></span>
				</p>
				<p class="MsoNormal" align="left" style="text-align:left;background:white;
mso-layout-grid-align:none;text-autospace:none;border:none;mso-border-alt:dashed windowtext .25pt;
padding:0cm;mso-padding-alt:0cm 0cm 0cm 0cm"><span style="font-size:14.0pt;
font-family:'微软雅黑','sans-serif';mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin;mso-bidi-font-family:微软雅黑;color:black;mso-font-kerning:0pt;
mso-ansi-language:ZH-CN">4. RateLimiter的创建流程<o:p></o:p></span>
				</p>
				<p class="MsoNormal" align="left" style="text-align:left;background:white;
mso-layout-grid-align:none;text-autospace:none;border:none;mso-border-alt:dashed windowtext .25pt;
padding:0cm;mso-padding-alt:0cm 0cm 0cm 0cm"><span style="font-size:14.0pt;
font-family:'微软雅黑','sans-serif';mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin;mso-bidi-font-family:微软雅黑;color:black;mso-font-kerning:0pt;
mso-ansi-language:ZH-CN"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>4.1
create(double, SleepingStopwatch)--每秒生成令牌数，计算时间对象；<o:p></o:p></span>
				</p>
			</div>
			<div style="mso-element:para-border-div;border:dashed windowtext 1.0pt;
mso-border-alt:dashed windowtext .25pt;padding:0cm 0cm 0cm 0cm;background:white;
margin-left:80.0pt;margin-right:0cm">
				<p class="MsoNormal" align="left" style="text-align:left;background:white;
mso-layout-grid-align:none;text-autospace:none;border:none;mso-border-alt:dashed windowtext .25pt;
padding:0cm;mso-padding-alt:0cm 0cm 0cm 0cm"><strong><span style="font-size:13.5pt;
font-family:??;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;
mso-bidi-font-family:??;color:navy;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">static</span></strong><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:black;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">RateLimiter create(</span><strong><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:navy;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">double </span></strong><span style="font-size:13.5pt;
font-family:??;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;
mso-bidi-font-family:??;color:black;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN">permitsPerSecond, SleepingStopwatch stopwatch) {<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span><em><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:gray;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">// 创建RateLimiter，并设置 maxBurstSeconds = 1<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span></em><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:black;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">RateLimiter rateLimiter = </span><strong><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:navy;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">new </span></strong><span style="font-size:13.5pt;
font-family:??;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;
mso-bidi-font-family:??;color:black;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN">SmoothBursty(stopwatch, </span><span style="font-size:13.5pt;font-family:
??;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;mso-bidi-font-family:
??;color:blue;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">1.0 </span><em><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:gray;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">/* maxBurstSeconds */</span></em><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:black;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">);<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span><em><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:gray;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">// 设置 rateLimiter 生成令牌的速率<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span></em><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:black;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">rateLimiter.</span><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:red;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">setRate</span><span style="font-size:13.5pt;
font-family:??;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;
mso-bidi-font-family:??;color:black;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN">(permitsPerSecond);<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span><strong><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:navy;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">return </span></strong><span style="font-size:13.5pt;
font-family:??;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;
mso-bidi-font-family:??;color:black;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN">rateLimiter;<br />}</span><span style="font-size:14.0pt;font-family:'微软雅黑','sans-serif';
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;mso-bidi-font-family:
微软雅黑;color:black;mso-font-kerning:0pt;mso-ansi-language:ZH-CN"><o:p></o:p></span>
				</p>
			</div>
			<div style="mso-element:para-border-div;border:dashed windowtext 1.0pt;
mso-border-alt:dashed windowtext .25pt;padding:0cm 0cm 0cm 0cm;background:white">
				<p class="MsoNormal" align="left" style="text-align:left;background:white;
mso-layout-grid-align:none;text-autospace:none;border:none;mso-border-alt:dashed windowtext .25pt;
padding:0cm;mso-padding-alt:0cm 0cm 0cm 0cm"><span style="font-size:14.0pt;
font-family:'微软雅黑','sans-serif';mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin;mso-bidi-font-family:微软雅黑;color:black;mso-font-kerning:0pt;
mso-ansi-language:ZH-CN"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>4.2
setRate(double)--每秒生成令牌数；<o:p></o:p></span>
				</p>
			</div>
			<div style="mso-element:para-border-div;border:dashed windowtext 1.0pt;
mso-border-alt:dashed windowtext .25pt;padding:0cm 0cm 0cm 0cm;background:white;
margin-left:60.0pt;margin-right:0cm">
				<p class="MsoNormal" align="left" style="text-align:left;background:white;
mso-layout-grid-align:none;text-autospace:none;border:none;mso-border-alt:dashed windowtext .25pt;
padding:0cm;mso-padding-alt:0cm 0cm 0cm 0cm"><strong><span style="font-size:13.5pt;
font-family:??;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;
mso-bidi-font-family:??;color:navy;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">public
final void </span></strong><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:black;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">setRate(</span><strong><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:navy;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">double </span></strong><span style="font-size:13.5pt;
font-family:??;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;
mso-bidi-font-family:??;color:black;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN">permitsPerSecond) {<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span><em><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:gray;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">// 检查参数<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span></em><em><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:black;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">checkArgument</span></em><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:black;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">(permitsPerSecond &gt; </span><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:blue;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">0.0 </span><span style="font-size:13.5pt;
font-family:??;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;
mso-bidi-font-family:??;color:black;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN">&amp;&amp; !Double.<em>isNaN</em>(permitsPerSecond), </span><strong><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:green;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">&quot;rate must be positive&quot;</span></strong><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:black;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">);<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span><em><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:gray;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">// 使用synchronized进行互斥，避免同步修改速率<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span></em><strong><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:navy;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">synchronized </span></strong><span style="font-size:
13.5pt;font-family:??;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;
mso-bidi-font-family:??;color:black;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN">(mutex()) {<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><em><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:gray;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">// 修改速率<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>// stopwatch.readMicros()：当前时间，微秒为单位<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span></em><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:red;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">doSetRate</span><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:black;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">(permitsPerSecond,
stopwatch.readMicros());<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>}<br />}</span><span style="font-size:14.0pt;font-family:'微软雅黑','sans-serif';
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;mso-bidi-font-family:
微软雅黑;color:black;mso-font-kerning:0pt;mso-ansi-language:ZH-CN"><o:p></o:p></span>
				</p>
			</div>
			<div style="mso-element:para-border-div;border:dashed windowtext 1.0pt;
mso-border-alt:dashed windowtext .25pt;padding:0cm 0cm 0cm 0cm;background:white">
				<p class="MsoNormal" align="left" style="text-align:left;background:white;
mso-layout-grid-align:none;text-autospace:none;border:none;mso-border-alt:dashed windowtext .25pt;
padding:0cm;mso-padding-alt:0cm 0cm 0cm 0cm"><span style="font-size:14.0pt;
font-family:'微软雅黑','sans-serif';mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin;mso-bidi-font-family:微软雅黑;color:black;mso-font-kerning:0pt;
mso-ansi-language:ZH-CN"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>4.3
doSetRate(double, long)--每秒生成令牌数，当前时间；<o:p></o:p></span>
				</p>
			</div>
			<div style="mso-element:para-border-div;border:dashed windowtext 1.0pt;
mso-border-alt:dashed windowtext .25pt;padding:0cm 0cm 0cm 0cm;background:white;
margin-left:60.0pt;margin-right:0cm">
				<p class="MsoNormal" align="left" style="text-align:left;background:white;
mso-layout-grid-align:none;text-autospace:none;border:none;mso-border-alt:dashed windowtext .25pt;
padding:0cm;mso-padding-alt:0cm 0cm 0cm 0cm"><strong><span style="font-size:13.5pt;
font-family:??;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;
mso-bidi-font-family:??;color:navy;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">final
void </span></strong><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:black;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">doSetRate(</span><strong><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:navy;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">double </span></strong><span style="font-size:13.5pt;
font-family:??;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;
mso-bidi-font-family:??;color:black;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN">permitsPerSecond, </span><strong><span style="font-size:13.5pt;font-family:
??;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;mso-bidi-font-family:
??;color:navy;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">long </span></strong><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:black;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">nowMicros) {<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span><em><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:gray;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">// 尝试是否可以生成令牌，并更新下一次获取令牌时间nextFreeTicketMicros<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span></em><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:red;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">resync</span><span style="font-size:13.5pt;
font-family:??;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;
mso-bidi-font-family:??;color:black;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN">(nowMicros);<br /><span style="mso-spacerun:yes">&nbsp;</span><span style="mso-spacerun:yes">&nbsp;&nbsp; </span></span><em><span style="font-size:
13.5pt;font-family:??;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;
mso-bidi-font-family:??;color:gray;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">//
计算生成令牌的时间间隔,即多少微秒产生一个令牌<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>//
SECONDS.toMicros(1L)：将秒转换成微秒<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span></em><strong><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:navy;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">double </span></strong><span style="font-size:13.5pt;
font-family:??;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;
mso-bidi-font-family:??;color:black;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN">stableIntervalMicros = </span><strong><em><span style="font-size:13.5pt;
font-family:??;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;
mso-bidi-font-family:??;color:#660E7A;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN">SECONDS</span></em></strong><span style="font-size:13.5pt;font-family:??;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;mso-bidi-font-family:
??;color:black;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">.toMicros(</span><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:blue;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">1L</span><span style="font-size:13.5pt;font-family:
??;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;mso-bidi-font-family:
??;color:black;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">) /
permitsPerSecond;<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span><em><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:gray;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">// 更新生成令牌的时间间隔<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span></em><strong><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:navy;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">this</span></strong><span style="font-size:13.5pt;
font-family:??;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;
mso-bidi-font-family:??;color:black;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN">.stableIntervalMicros = stableIntervalMicros;<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span><em><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:gray;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">// 更新可存储最大令牌数maxPermits以及存储的令牌storedPermits<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span></em><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:red;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">doSetRate</span><span style="font-size:13.5pt;
font-family:??;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;
mso-bidi-font-family:??;color:black;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN">(permitsPerSecond, stableIntervalMicros);<br />}</span><span style="font-size:14.0pt;font-family:'微软雅黑','sans-serif';
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;mso-bidi-font-family:
微软雅黑;color:black;mso-font-kerning:0pt;mso-ansi-language:ZH-CN"><o:p></o:p></span>
				</p>
			</div>
			<div style="mso-element:para-border-div;border:dashed windowtext 1.0pt;
mso-border-alt:dashed windowtext .25pt;padding:0cm 0cm 0cm 0cm;background:white">
				<p class="MsoNormal" align="left" style="text-align:left;background:white;
mso-layout-grid-align:none;text-autospace:none;border:none;mso-border-alt:dashed windowtext .25pt;
padding:0cm;mso-padding-alt:0cm 0cm 0cm 0cm"><span style="font-size:14.0pt;
font-family:'微软雅黑','sans-serif';mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin;mso-bidi-font-family:微软雅黑;color:black;mso-font-kerning:0pt;
mso-ansi-language:ZH-CN"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>4.4
resync(long)--当前时间；<o:p></o:p></span>
				</p>
			</div>
			<div style="mso-element:para-border-div;border:dashed windowtext 1.0pt;
mso-border-alt:dashed windowtext .25pt;padding:0cm 0cm 0cm 0cm;background:white;
margin-left:60.0pt;margin-right:0cm">
				<p class="MsoNormal" align="left" style="text-align:left;background:white;
mso-layout-grid-align:none;text-autospace:none;border:none;mso-border-alt:dashed windowtext .25pt;
padding:0cm;mso-padding-alt:0cm 0cm 0cm 0cm"><strong><span style="font-size:13.5pt;
font-family:??;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;
mso-bidi-font-family:??;color:navy;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">void</span></strong><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:black;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">resync(</span><strong><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:navy;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">long </span></strong><span style="font-size:13.5pt;
font-family:??;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;
mso-bidi-font-family:??;color:black;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN">nowMicros) {<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span><em><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:gray;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">// 如果当前时间nowMicros &gt; 下次获取令牌时间nextFreeTicketMicros<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span></em><strong><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:navy;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">if </span></strong><span style="font-size:13.5pt;
font-family:??;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;
mso-bidi-font-family:??;color:black;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN">(nowMicros &gt; nextFreeTicketMicros) {<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><em><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:gray;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">// 计算在nowMicros -
nextFreeTicketMicros这段时间内生成的令牌<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span></em><strong><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:navy;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">double </span></strong><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:black;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">newPermits = (nowMicros -
nextFreeTicketMicros) / coolDownIntervalMicros();<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><em><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:gray;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">// 将令牌存储起来，但不超过最大值maxPermits<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span></em><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:black;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">storedPermits = min(maxPermits,
storedPermits + newPermits);<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><em><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:gray;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">// 更新下一次生成的生成令牌的时间<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span></em><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:black;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">nextFreeTicketMicros = nowMicros;<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>}<br />}</span><span style="font-size:14.0pt;font-family:'微软雅黑','sans-serif';
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;mso-bidi-font-family:
微软雅黑;color:black;mso-font-kerning:0pt;mso-ansi-language:ZH-CN"><o:p></o:p></span>
				</p>
			</div>
			<div style="mso-element:para-border-div;border:dashed windowtext 1.0pt;
mso-border-alt:dashed windowtext .25pt;padding:0cm 0cm 0cm 0cm;background:white">
				<p class="MsoNormal" align="left" style="text-align:left;background:white;
mso-layout-grid-align:none;text-autospace:none;border:none;mso-border-alt:dashed windowtext .25pt;
padding:0cm;mso-padding-alt:0cm 0cm 0cm 0cm"><span style="font-size:14.0pt;
font-family:'微软雅黑','sans-serif';mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin;mso-bidi-font-family:微软雅黑;color:black;mso-font-kerning:0pt;
mso-ansi-language:ZH-CN"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>4.5
doSetRate(double, double)--每秒生成令牌数，多少微秒生成一个令牌；<o:p></o:p></span>
				</p>
			</div>
			<div style="mso-element:para-border-div;border:dashed windowtext 1.0pt;
mso-border-alt:dashed windowtext .25pt;padding:0cm 0cm 0cm 0cm;background:white;
margin-left:60.0pt;margin-right:0cm">
				<p class="MsoNormal" align="left" style="text-align:left;background:white;
mso-layout-grid-align:none;text-autospace:none;border:none;mso-border-alt:dashed windowtext .25pt;
padding:0cm;mso-padding-alt:0cm 0cm 0cm 0cm"><strong><span style="font-size:13.5pt;
font-family:??;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;
mso-bidi-font-family:??;color:navy;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">void</span></strong><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:black;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">doSetRate(</span><strong><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:navy;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">double </span></strong><span style="font-size:13.5pt;
font-family:??;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;
mso-bidi-font-family:??;color:black;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN">permitsPerSecond, </span><strong><span style="font-size:13.5pt;font-family:
??;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;mso-bidi-font-family:
??;color:navy;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">double </span></strong><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:black;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">stableIntervalMicros) {<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span><em><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:gray;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">// 旧最大令牌存储值<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span></em><strong><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:navy;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">double </span></strong><span style="font-size:13.5pt;
font-family:??;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;
mso-bidi-font-family:??;color:black;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN">oldMaxPermits = </span><strong><span style="font-size:13.5pt;font-family:
??;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;mso-bidi-font-family:
??;color:navy;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">this</span></strong><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:black;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">.maxPermits;<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span><em><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:gray;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">// 新最大令牌存储值<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span></em><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:black;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">maxPermits = maxBurstSeconds *
permitsPerSecond;<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span><strong><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:navy;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">if </span></strong><span style="font-size:13.5pt;
font-family:??;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;
mso-bidi-font-family:??;color:black;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN">(oldMaxPermits == Double.</span><strong><em><span style="font-size:13.5pt;
font-family:??;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;
mso-bidi-font-family:??;color:#660E7A;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN">POSITIVE_INFINITY</span></em></strong><span style="font-size:13.5pt;
font-family:??;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;
mso-bidi-font-family:??;color:black;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN">) {<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><em><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:gray;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">// 设置存储令牌为最大值<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span></em><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:black;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">storedPermits = maxPermits;<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>} </span><strong><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:navy;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">else </span></strong><span style="font-size:13.5pt;
font-family:??;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;
mso-bidi-font-family:??;color:black;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN">{<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><em><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:gray;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">// 修改存储的令牌数量，不能超过新的最大值<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span></em><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:black;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">storedPermits =(oldMaxPermits == </span><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:blue;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">0.0</span><span style="font-size:13.5pt;
font-family:??;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;
mso-bidi-font-family:??;color:black;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN">)? </span><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:blue;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">0.0</span><span style="font-size:
13.5pt;font-family:??;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;
mso-bidi-font-family:??;color:black;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN">: storedPermits * maxPermits / oldMaxPermits;<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>}<br />}</span><span style="font-size:14.0pt;font-family:'微软雅黑','sans-serif';
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;mso-bidi-font-family:
微软雅黑;color:black;mso-font-kerning:0pt;mso-ansi-language:ZH-CN"><o:p></o:p></span>
				</p>
			</div>
			<div style="mso-element:para-border-div;border:dashed windowtext 1.0pt;
mso-border-alt:dashed windowtext .25pt;padding:0cm 0cm 0cm 0cm;background:white">
				<p class="MsoNormal" align="left" style="text-align:left;background:white;
mso-layout-grid-align:none;text-autospace:none;border:none;mso-border-alt:dashed windowtext .25pt;
padding:0cm;mso-padding-alt:0cm 0cm 0cm 0cm"><span style="font-size:14.0pt;
font-family:'微软雅黑','sans-serif';mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin;mso-bidi-font-family:微软雅黑;color:black;mso-font-kerning:0pt;
mso-ansi-language:ZH-CN"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><o:p></o:p></span>
				</p>
				<p class="MsoNormal" align="left" style="text-align:left;background:white;
mso-layout-grid-align:none;text-autospace:none;border:none;mso-border-alt:dashed windowtext .25pt;
padding:0cm;mso-padding-alt:0cm 0cm 0cm 0cm"><span style="font-size:14.0pt;
font-family:'微软雅黑','sans-serif';mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin;mso-bidi-font-family:微软雅黑;color:black;mso-font-kerning:0pt;
mso-ansi-language:ZH-CN">5. 获取令牌流程<o:p></o:p></span>
				</p>
				<p class="MsoNormal" align="left" style="text-align:left;background:white;
mso-layout-grid-align:none;text-autospace:none;border:none;mso-border-alt:dashed windowtext .25pt;
padding:0cm;mso-padding-alt:0cm 0cm 0cm 0cm"><span style="font-size:14.0pt;
font-family:'微软雅黑','sans-serif';mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin;mso-bidi-font-family:微软雅黑;color:black;mso-font-kerning:0pt;
mso-ansi-language:ZH-CN"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>5.1
acquire(int)--请求令牌数；<o:p></o:p></span>
				</p>
			</div>
			<div style="mso-element:para-border-div;border:dashed windowtext 1.0pt;
mso-border-alt:dashed windowtext .25pt;padding:0cm 0cm 0cm 0cm;background:white;
margin-left:60.0pt;margin-right:0cm">
				<p class="MsoNormal" align="left" style="text-align:left;background:white;
mso-layout-grid-align:none;text-autospace:none;border:none;mso-border-alt:dashed windowtext .25pt;
padding:0cm;mso-padding-alt:0cm 0cm 0cm 0cm"><strong><span style="font-size:13.5pt;
font-family:??;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;
mso-bidi-font-family:??;color:navy;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">public
double </span></strong><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:black;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">acquire(</span><strong><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:navy;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">int </span></strong><span style="font-size:13.5pt;
font-family:??;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;
mso-bidi-font-family:??;color:black;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN">permits) {<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span><em><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:gray;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">// 计算获取permits枚令牌要等待的时间<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span></em><strong><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:navy;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">long </span></strong><span style="font-size:13.5pt;
font-family:??;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;
mso-bidi-font-family:??;color:black;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN">microsToWait = </span><span style="font-size:13.5pt;font-family:??;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;mso-bidi-font-family:
??;color:red;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">reserve</span><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:black;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">(permits);<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span><em><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:gray;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">// 睡眠阻塞，且只有睡眠时间结束才可被中断<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span></em><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:black;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">stopwatch.sleepMicrosUninterruptibly(microsToWait);<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span><em><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:gray;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">// 返回等待时间<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span></em><strong><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:navy;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">return </span></strong><span style="font-size:13.5pt;
font-family:??;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;
mso-bidi-font-family:??;color:blue;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">1.0</span><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:black;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">* microsToWait / </span><strong><em><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:#660E7A;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">SECONDS</span></em></strong><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:black;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">.toMicros(</span><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:blue;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">1L</span><span style="font-size:13.5pt;font-family:
??;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;mso-bidi-font-family:
??;color:black;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">);<br />}<o:p></o:p></span>
				</p>
			</div>
			<div style="mso-element:para-border-div;border:dashed windowtext 1.0pt;
mso-border-alt:dashed windowtext .25pt;padding:0cm 0cm 0cm 0cm;background:white">
				<p class="MsoNormal" align="left" style="text-align:left;background:white;
mso-layout-grid-align:none;text-autospace:none;border:none;mso-border-alt:dashed windowtext .25pt;
padding:0cm;mso-padding-alt:0cm 0cm 0cm 0cm"><span style="font-size:14.0pt;
font-family:'微软雅黑','sans-serif';mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin;mso-bidi-font-family:微软雅黑;color:black;mso-font-kerning:0pt;
mso-ansi-language:ZH-CN"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>5.2
reserve(int)--请求令牌数；<o:p></o:p></span>
				</p>
			</div>
			<div style="mso-element:para-border-div;border:dashed windowtext 1.0pt;
mso-border-alt:dashed windowtext .25pt;padding:0cm 0cm 0cm 0cm;background:white;
margin-left:60.0pt;margin-right:0cm">
				<p class="MsoNormal" align="left" style="text-align:left;background:white;
mso-layout-grid-align:none;text-autospace:none;border:none;mso-border-alt:dashed windowtext .25pt;
padding:0cm;mso-padding-alt:0cm 0cm 0cm 0cm"><strong><span style="font-size:13.5pt;
font-family:??;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;
mso-bidi-font-family:??;color:navy;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">final
long </span></strong><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:black;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">reserve(</span><strong><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:navy;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">int </span></strong><span style="font-size:13.5pt;
font-family:??;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;
mso-bidi-font-family:??;color:black;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN">permits) {<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span><em><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:gray;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">// 检查参数<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span></em><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:black;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">checkPermits(permits);<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span><em><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:gray;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">// 开启synchronized同步互斥<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span></em><strong><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:navy;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">synchronized </span></strong><span style="font-size:
13.5pt;font-family:??;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;
mso-bidi-font-family:??;color:black;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN">(mutex()) {<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><em><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:gray;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">// 计算等待时间<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>// permits：要获取的令牌数<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>// stopwatch.readMicros()：当前时间<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span></em><strong><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:navy;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">return </span></strong><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:red;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">reserveAndGetWaitLength</span><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:black;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">(permits,
stopwatch.readMicros());<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>}<br />}</span><span style="font-size:14.0pt;font-family:'微软雅黑','sans-serif';
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;mso-bidi-font-family:
微软雅黑;color:black;mso-font-kerning:0pt;mso-ansi-language:ZH-CN"><o:p></o:p></span>
				</p>
			</div>
			<div style="mso-element:para-border-div;border:dashed windowtext 1.0pt;
mso-border-alt:dashed windowtext .25pt;padding:0cm 0cm 0cm 0cm;background:white">
				<p class="MsoNormal" align="left" style="text-align:left;background:white;
mso-layout-grid-align:none;text-autospace:none;border:none;mso-border-alt:dashed windowtext .25pt;
padding:0cm;mso-padding-alt:0cm 0cm 0cm 0cm"><span style="font-size:14.0pt;
font-family:'微软雅黑','sans-serif';mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin;mso-bidi-font-family:微软雅黑;color:black;mso-font-kerning:0pt;
mso-ansi-language:ZH-CN"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>5.3
reserveAndGetWaitLength(int, long)--请求令牌数，当前时间；<o:p></o:p></span>
				</p>
			</div>
			<div style="mso-element:para-border-div;border:dashed windowtext 1.0pt;
mso-border-alt:dashed windowtext .25pt;padding:0cm 0cm 0cm 0cm;background:white;
margin-left:60.0pt;margin-right:0cm">
				<p class="MsoNormal" align="left" style="text-align:left;background:white;
mso-layout-grid-align:none;text-autospace:none;border:none;mso-border-alt:dashed windowtext .25pt;
padding:0cm;mso-padding-alt:0cm 0cm 0cm 0cm"><strong><span style="font-size:13.5pt;
font-family:??;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;
mso-bidi-font-family:??;color:navy;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">final
long </span></strong><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:black;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">reserveAndGetWaitLength(</span><strong><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:navy;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">int </span></strong><span style="font-size:13.5pt;
font-family:??;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;
mso-bidi-font-family:??;color:black;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN">permits, </span><strong><span style="font-size:13.5pt;font-family:??;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;mso-bidi-font-family:
??;color:navy;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">long </span></strong><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:black;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">nowMicros) {<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span><em><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:gray;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">// momentAvailable：可以获取permits枚令牌的时间<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span></em><strong><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:navy;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">long </span></strong><span style="font-size:13.5pt;
font-family:??;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;
mso-bidi-font-family:??;color:black;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN">momentAvailable = </span><span style="font-size:13.5pt;font-family:??;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;mso-bidi-font-family:
??;color:red;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">reserveEarliestAvailable</span><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:black;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">(permits, nowMicros);<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span><em><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:gray;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">// 如果momentAvailable</span></em><em><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:gray;mso-font-kerning:
0pt"> </span></em><em><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:gray;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">&lt;</span></em><em><span lang="EN-US" style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:gray;mso-font-kerning:
0pt"><span style="mso-spacerun:yes">&nbsp; </span></span></em><em><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:gray;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">nowMicros,则返回0，无需睡眠，可以立即获取令牌<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>// 如果momentAvailable</span></em><em><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:gray;mso-font-kerning:
0pt"> </span></em><em><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:gray;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">&gt;</span></em><em><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:gray;mso-font-kerning:
0pt"> </span></em><em><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:gray;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">nowMicros,则返回momentAvailable -
nowMicros，即睡眠momentAvailable - nowMicros时间后才能获得permits枚令牌<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span></em><strong><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:navy;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">return </span></strong><em><span style="font-size:13.5pt;
font-family:??;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;
mso-bidi-font-family:??;color:black;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN">max</span></em><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:black;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">(momentAvailable - nowMicros, </span><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:blue;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">0</span><span style="font-size:13.5pt;font-family:
??;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;mso-bidi-font-family:
??;color:black;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">);<br />}</span><span style="font-size:14.0pt;font-family:'微软雅黑','sans-serif';
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;mso-bidi-font-family:
微软雅黑;color:black;mso-font-kerning:0pt;mso-ansi-language:ZH-CN"><o:p></o:p></span>
				</p>
			</div>
			<div style="mso-element:para-border-div;border:dashed windowtext 1.0pt;
mso-border-alt:dashed windowtext .25pt;padding:0cm 0cm 0cm 0cm;background:white">
				<p class="MsoNormal" align="left" style="text-align:left;background:white;
mso-layout-grid-align:none;text-autospace:none;border:none;mso-border-alt:dashed windowtext .25pt;
padding:0cm;mso-padding-alt:0cm 0cm 0cm 0cm"><span style="font-size:14.0pt;
font-family:'微软雅黑','sans-serif';mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin;mso-bidi-font-family:微软雅黑;color:black;mso-font-kerning:0pt;
mso-ansi-language:ZH-CN"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>5.4
reserveEarliestAvailable(int, long)--请求令牌数，当前时间；<o:p></o:p></span>
				</p>
			</div>
			<div style="mso-element:para-border-div;border:dashed windowtext 1.0pt;
mso-border-alt:dashed windowtext .25pt;padding:0cm 0cm 0cm 0cm;background:white;
margin-left:60.0pt;margin-right:0cm">
				<p class="MsoNormal" align="left" style="text-align:left;background:white;
mso-layout-grid-align:none;text-autospace:none;border:none;mso-border-alt:dashed windowtext .25pt;
padding:0cm;mso-padding-alt:0cm 0cm 0cm 0cm"><strong><span style="font-size:13.5pt;
font-family:??;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;
mso-bidi-font-family:??;color:navy;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">final
long </span></strong><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:black;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">reserveEarliestAvailable(</span><strong><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:navy;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">int </span></strong><span style="font-size:13.5pt;
font-family:??;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;
mso-bidi-font-family:??;color:black;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN">requiredPermits, </span><strong><span style="font-size:13.5pt;font-family:
??;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;mso-bidi-font-family:
??;color:navy;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">long </span></strong><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:black;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">nowMicros) {<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span><em><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:gray;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">// 生成令牌，并更新下一次获取令牌时间nextFreeTicketMicros<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span></em><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:black;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">resync(nowMicros);<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span><em><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:gray;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">// 记录下次获取令牌的时间<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span></em><strong><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:navy;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">long </span></strong><span style="font-size:13.5pt;
font-family:??;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;
mso-bidi-font-family:??;color:black;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN">returnValue = nextFreeTicketMicros;<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span><em><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:gray;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">// 取requiredPermits（要获取的令牌数）和storedPermits（存储令牌数）较小的一个<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span></em><strong><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:navy;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">double </span></strong><span style="font-size:13.5pt;
font-family:??;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;
mso-bidi-font-family:??;color:black;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN">storedPermitsToSpend = min(requiredPermits, </span><strong><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:navy;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">this</span></strong><span style="font-size:13.5pt;
font-family:??;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;
mso-bidi-font-family:??;color:black;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN">.storedPermits);<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span><em><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:gray;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">// 保证freshPermits &gt;= 0<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>// 如果存储令牌足够，则freshPermits
= 0<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>// 否则，freshPermits
&gt; 0<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span></em><strong><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:navy;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">double </span></strong><span style="font-size:13.5pt;
font-family:??;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;
mso-bidi-font-family:??;color:black;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN">freshPermits = requiredPermits - storedPermitsToSpend;<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span><em><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:gray;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">// 计算要等待的时间，如果freshPermits=0，则waitMicros = 0，表示存储令牌足够<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span></em><strong><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:navy;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">long </span></strong><span style="font-size:13.5pt;
font-family:??;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;
mso-bidi-font-family:??;color:black;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN">waitMicros = + (</span><strong><span style="font-size:13.5pt;font-family:
??;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;mso-bidi-font-family:
??;color:navy;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">long</span></strong><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:black;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">) (freshPermits *
stableIntervalMicros);<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span><em><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:gray;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">// 更新下次获取令牌时间，即nextFreeTicketMicros =
nextFreeTicketMicros + waitMicros<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span></em><strong><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:navy;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">this</span></strong><span style="font-size:13.5pt;
font-family:??;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;
mso-bidi-font-family:??;color:black;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN">.nextFreeTicketMicros = LongMath.<em>saturatedAdd</em>(nextFreeTicketMicros,
waitMicros);<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span><em><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:gray;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">// 减去存储令牌数量<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span></em><strong><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:navy;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">this</span></strong><span style="font-size:13.5pt;
font-family:??;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;
mso-bidi-font-family:??;color:black;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN">.storedPermits -= storedPermitsToSpend;<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span><em><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:gray;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">// 返回旧的nextFreeTicketMicros<br /><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span></em><strong><span style="font-size:13.5pt;font-family:??;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin;mso-bidi-font-family:??;color:navy;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">return </span></strong><span style="font-size:13.5pt;
font-family:??;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin;
mso-bidi-font-family:??;color:black;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN">returnValue;<br />}<o:p></o:p></span>
				</p>
				<p class="MsoNormal" align="left" style="text-align:left;background:white;
mso-layout-grid-align:none;text-autospace:none;border:none;mso-border-alt:dashed windowtext .25pt;
padding:0cm;mso-padding-alt:0cm 0cm 0cm 0cm"><span style="font-size:14.0pt;
font-family:'微软雅黑','sans-serif';mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin;mso-bidi-font-family:微软雅黑;color:black;mso-font-kerning:0pt;
mso-ansi-language:ZH-CN"><o:p>&nbsp;</o:p></span>
				</p>
			</div>
			<div style="mso-element:para-border-div;border:dashed windowtext 1.0pt;
mso-border-alt:dashed windowtext .25pt;padding:0cm 0cm 0cm 0cm;background:white">
				<p class="MsoNormal" align="left" style="text-align:left;background:white;
mso-layout-grid-align:none;text-autospace:none;border:none;mso-border-alt:dashed windowtext .25pt;
padding:0cm;mso-padding-alt:0cm 0cm 0cm 0cm"><span style="font-size:14.0pt;
font-family:'微软雅黑','sans-serif';mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin;mso-bidi-font-family:微软雅黑;color:black;mso-font-kerning:0pt;
mso-ansi-language:ZH-CN"><o:p>&nbsp;</o:p></span>
				</p>
				<p class="MsoNormal" align="left" style="text-align:left;background:white;
mso-layout-grid-align:none;text-autospace:none;border:none;mso-border-alt:dashed windowtext .25pt;
padding:0cm;mso-padding-alt:0cm 0cm 0cm 0cm"><span style="font-size:14.0pt;
font-family:'微软雅黑','sans-serif';mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin;mso-bidi-font-family:微软雅黑;color:black;mso-font-kerning:0pt;
mso-ansi-language:ZH-CN"><span style="mso-tab-count:2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><o:p></o:p></span>
				</p>
				<p class="MsoNormal" align="left" style="text-align:left;background:white;
mso-layout-grid-align:none;text-autospace:none;border:none;mso-border-alt:dashed windowtext .25pt;
padding:0cm;mso-padding-alt:0cm 0cm 0cm 0cm"><span style="font-size:14.0pt;
font-family:'微软雅黑','sans-serif';mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin;mso-bidi-font-family:微软雅黑;color:black;mso-font-kerning:0pt;
mso-ansi-language:ZH-CN"><o:p>&nbsp;</o:p></span>
				</p>
				<p class="MsoNormal" align="left" style="text-align:left;background:white;
mso-layout-grid-align:none;text-autospace:none;border:none;mso-border-alt:dashed windowtext .25pt;
padding:0cm;mso-padding-alt:0cm 0cm 0cm 0cm"><span style="font-size:14.0pt;
font-family:'微软雅黑','sans-serif';mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin;mso-bidi-font-family:微软雅黑;color:black;mso-font-kerning:0pt;
mso-ansi-language:ZH-CN"><o:p>&nbsp;</o:p></span>
				</p>
				<p class="MsoNormal" align="left" style="text-align:left;background:white;
mso-layout-grid-align:none;text-autospace:none;border:none;mso-border-alt:dashed windowtext .25pt;
padding:0cm;mso-padding-alt:0cm 0cm 0cm 0cm"><span style="font-size:14.0pt;
font-family:'微软雅黑','sans-serif';mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin;mso-bidi-font-family:微软雅黑;color:black;mso-font-kerning:0pt;
mso-ansi-language:ZH-CN"><o:p>&nbsp;</o:p></span>
				</p>
				<p class="MsoNormal" align="left" style="text-align:left;background:white;
mso-layout-grid-align:none;text-autospace:none;border:none;mso-border-alt:dashed windowtext .25pt;
padding:0cm;mso-padding-alt:0cm 0cm 0cm 0cm"><span style="font-size:14.0pt;
font-family:'微软雅黑','sans-serif';mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin;mso-bidi-font-family:微软雅黑;color:black;mso-font-kerning:0pt;
mso-ansi-language:ZH-CN"><o:p>&nbsp;</o:p></span>
				</p>
			</div>
		</div>
	
<footer style="">
<hr noshade>
<a href="b57c09e2_2e8205f1_0.txt" title="b57c09e2_2e8205f1_0.txt" target=_blank style="padding-left: 1em; background: URL(icon_attachment.gif) no-repeat center left; padding: 0 0 0 16px;">RateLimiter.txt</a>
<a href="b57c09e2_1aed0409_0.png" title="b57c09e2_1aed0409_0.png" target=_blank style="padding-left: 1em; background: URL(icon_attachment.gif) no-repeat center left; padding: 0 0 0 16px;">image002.png</a>
<hr noshade>
</footer>
<script type="text/javascript" language="javascript" src="jquery.js"></script>
<script type="text/javascript" language="javascript" src="itemlink.js"></script></body>
</html>